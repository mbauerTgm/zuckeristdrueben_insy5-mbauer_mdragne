name: CI â€“ Build & Tests

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches:
      - main
    
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  checks: write
  statuses: write

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set full permissions on entire workspace
        run: |
          sudo chown -R $USER:$USER $GITHUB_WORKSPACE
          sudo chmod -R 777 $GITHUB_WORKSPACE
        
      - name: Create .env file
        run: |
          echo "POSTGRES_USER=postgres" >> .env
          echo "POSTGRES_PASSWORD=postgres" >> .env
          echo "POSTGRES_DB=venlab" >> .env
          echo "JWT_SECRET=test-secret-key-for-ci-testing" >> .env
        
      - name: Create docker-compose override for CI
        run: |
          cat > docker-compose.ci.yml << 'EOF'
          services:
            frontend:
              volumes: null
          EOF
          cat docker-compose.ci.yml
        
      - name: Build and start containers
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d --build
        
      - name: Wait for services
        run: |
          echo "Waiting for containers to start..."
          sleep 20
          docker ps -a
          
      - name: Ensure clean database
        run: |
          docker exec -i zuckerpostgres psql -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname='venlab';"
          docker exec -i zuckerpostgres psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS venlab;"
          docker exec -i zuckerpostgres psql -U postgres -d postgres -c "CREATE DATABASE venlab;"


      - name: Restore database
        run: |
          docker exec -i zuckerpostgres psql -U postgres -d venlab < db_init_schema/init_schema.sql

      - name: Insert CI test user
        run: |
          docker exec -i zuckerpostgres psql -U postgres -d venlab <<'EOF'
          INSERT INTO venlab.users (username, password_hash, role_id, created_at)
          VALUES (
            'TestAdmin',
            '$2a$12$/x3aVXCCLs6YCvN5O4lwhu3TLNLfncNqhRAiIrkfFXkC0GrPYVU..',
            1,
            NOW()
          );
          EOF

      - name: Restart backend after DB reset
        run: docker restart rest_backend


      - name: Wait for frontend build
        run: |
          echo "Waiting for frontend build..."
          for i in {1..90}; do
            if docker exec frontend_istFrueben test -f /usr/share/nginx/html/index.html 2>/dev/null; then
              echo "Frontend ready!"
              break
            fi
            if [ $i -eq 90 ]; then
              echo "Timeout!"
              docker logs frontend_istFrueben
              exit 1
            fi
            sleep 2
          done
        
      - name: Verify frontend
        run: |
          curl -f http://localhost:8082 || (docker logs frontend && exit 1)
          echo "Frontend accessible"
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
          cache-dependency-path: web/frontend/yarn.lock

      - name: Remove node_modules created by Docker
        run: |
          sudo rm -rf web/frontend/node_modules
          sudo rm -rf web/frontend/.yarn
          sudo rm -rf web/frontend/.cache

      - name: Install dependencies
        run: |
          cd web/frontend
          yarn install --frozen-lockfile
        
      - name: Run Cypress E2E tests
        run: |
          cd web/frontend
          yarn test:report
        continue-on-error: false
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: |
            web/frontend/cypress/videos
            web/frontend/cypress/reports
          if-no-files-found: ignore
          
      - name: Comment test results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## Test Results\n\n';
            
            if (fs.existsSync('web/frontend/cypress/reports')) {
              comment += 'Cypress tests completed\n';
              comment += 'Check artifacts for detailed results\n';
            } else {
              comment += 'No test reports found\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== FRONTEND ==="
          docker logs frontend_istFrueben
          echo "=== BACKEND ==="
          docker logs rest_backend
          echo "=== POSTGRES ==="
          docker logs zuckerpostgres
          
      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v
